name: Test Website Structure

on:
  schedule:
    - cron: "0 */2 * * *"
  workflow_dispatch:

jobs:
  check-selectors:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    runs-on: ${{ matrix.os }}
    timeout-minutes: 7

    env:
      FAKE_PASSWORD: ${{ secrets.FAKE_PASSWORD }}
      FAKE_EMAIL: ${{ secrets.FAKE_EMAIL }}
      PROXY_HOST: ${{ secrets.PROXY_HOST }}
      PROXY_USER: ${{ secrets.PROXY_USER }}
      PROXY_PASS: ${{ secrets.PROXY_PASS }}

    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-go@v6
        with:
          go-version: ">=1.25.5"
      
      - name: Build Binary
        shell: bash
        run: |
          if [[ "$RUNNER_OS" == 'Windows' ]]; then
            go build -o paddock.exe ./
          else
            go build -o paddock ./
          fi

      - name: Set Browser Paths
        shell: bash
        run: |
          if [[ "$RUNNER_OS" == 'Linux' ]]; then
            echo "CHROME_PATH=/usr/bin/google-chrome" >> $GITHUB_ENV
            echo "EDGE_PATH=/usr/bin/microsoft-edge" >> $GITHUB_ENV
            echo "BIN_NAME=./paddock" >> $GITHUB_ENV

          elif [[ "$RUNNER_OS" == 'Windows' ]]; then
            echo "CHROME_PATH=C:\Program Files\Google\Chrome\Application\chrome.exe" >> $GITHUB_ENV
            echo "EDGE_PATH=C:\Program Files (x86)\Microsoft\Edge\Application\msedge.exe" >> $GITHUB_ENV
            echo "BIN_NAME=./paddock.exe" >> $GITHUB_ENV

          elif [[ "$RUNNER_OS" == 'macOS' ]]; then
            echo "CHROME_PATH=/Applications/Google Chrome.app/Contents/MacOS/Google Chrome" >> $GITHUB_ENV
            echo "EDGE_PATH=/Applications/Microsoft Edge.app/Contents/MacOS/Microsoft Edge" >> $GITHUB_ENV
            echo "BIN_NAME=./paddock" >> $GITHUB_ENV
          fi

      - name: Run Test
        shell: bash
        run: |
          run_test() {
            local test_name=$1
            local path_flag=$2
            local use_proxy=$3
            
            echo "Testing: $test_name (Proxy: ${use_proxy:-false})"
            
            if [[ "$use_proxy" == "true" ]]; then
                OUTPUT=$(PROXY_HOST="$PROXY_HOST" PROXY_USER="$PROXY_USER" PROXY_PASS="$PROXY_PASS" PASSWORD="$FAKE_PASSWORD" $BIN_NAME --email="$FAKE_EMAIL" --headless --path="$path_flag" 2>&1 || true)
            else
                OUTPUT=$(PASSWORD="$FAKE_PASSWORD" $BIN_NAME --email="$FAKE_EMAIL" --headless --path="$path_flag" 2>&1 || true)
            fi
            
            echo "$path_flag"
            echo "$OUTPUT"

            ERROR=$(echo "$OUTPUT" | jq -r '.error' 2>/dev/null || echo "")

            if [[ "$ERROR" == *401* ]] || echo "$OUTPUT" | grep -q "401"; then
               echo "SUCCESS ($test_name) (Status Code: 401)"
               return 0
            elif [[ "$ERROR" == *403* ]] || echo "$OUTPUT" | grep -q "403"; then
               echo "SUCCESS ($test_name) (Status Code: 403)"
               return 0
            else
               echo "FAILURE ($test_name)"
               return 1
            fi
          }

          EXIT_CODE=0
            
          run_test "Auto-Detect" "" "false" || EXIT_CODE=1

          if [ -n "$CHROME_PATH" ]; then
            run_test "Google Chrome" "$CHROME_PATH" "true" || EXIT_CODE=1
          fi

          if [ -n "$EDGE_PATH" ]; then
            run_test "Microsoft Edge" "$EDGE_PATH" "false" || EXIT_CODE=1
          fi

          if [ "$EXIT_CODE" == '1' ]; then
            exit 1
          fi